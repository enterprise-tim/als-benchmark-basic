name: AsyncLocalStorage Benchmark

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      iterations:
        description: 'Number of iterations per version (default: 10)'
        required: false
        default: '10'
        type: number
      run_memory_tests:
        description: 'Run memory profiling tests'
        required: false
        default: 'true'
        type: boolean

jobs:
  setup-versions:
    runs-on: ubuntu-latest-4-cores
    outputs:
      node-versions: ${{ steps.get-versions.outputs.versions }}
      version-count: ${{ steps.get-versions.outputs.count }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Get configured Node.js versions
      id: get-versions
      run: |
        # Extract all active versions from node-versions.json
        VERSIONS=$(node -e "
          const config = JSON.parse(require('fs').readFileSync('config/node-versions.json', 'utf8'));
          const activeVersions = Object.entries(config.versions)
            .filter(([key, version]) => version.active)
            .map(([key, version]) => version.exact)
            .sort((a, b) => {
              const aParts = a.split('.').map(Number);
              const bParts = b.split('.').map(Number);
              for (let i = 0; i < Math.max(aParts.length, bParts.length); i++) {
                const aPart = aParts[i] || 0;
                const bPart = bParts[i] || 0;
                if (aPart !== bPart) return aPart - bPart;
              }
              return 0;
            });
          console.log('::set-output name=versions::' + activeVersions.join(','));
          console.log('::set-output name=count::' + activeVersions.length);
        ")
        echo "Found ${{ steps.get-versions.outputs.count }} Node.js versions to test"
        echo "Versions: ${{ steps.get-versions.outputs.node-versions }}"

  benchmark:
    runs-on: ubuntu-latest-4-cores
    needs: setup-versions
    strategy:
      matrix:
        node-version: ${{ fromJson(format('[{0}]', needs.setup-versions.outputs.node-versions)) }}
      fail-fast: false
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Verify Node.js version
      run: |
        echo "Expected Node.js version: ${{ matrix.node-version }}"
        echo "Actual Node.js version: $(node --version)"
        if [ "$(node --version)" != "v${{ matrix.node-version }}" ]; then
          echo "❌ Node.js version mismatch!"
          exit 1
        fi
        echo "✅ Node.js version verified"
    
    - name: Run multi-iteration benchmarks
      run: |
        echo "🚀 Running ${{ github.event.inputs.iterations || 10 }} iterations for Node.js ${{ matrix.node-version }}"
        npm run multi-iteration ${{ github.event.inputs.iterations || 10 }}
        
    - name: Run memory profiling tests
      if: ${{ github.event.inputs.run_memory_tests != 'false' }}
      run: |
        echo "🧠 Running memory tests for Node.js ${{ matrix.node-version }}"
        node --expose-gc src/memory-test.js
        
        # Copy memory results to version directory
        if [ -d "results/versions/node_${{ matrix.node-version }}" ]; then
          mkdir -p "results/versions/node_${{ matrix.node-version }}/memory"
          find results -name "memory_*.json" -exec cp {} "results/versions/node_${{ matrix.node-version }}/memory/" \;
        fi
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results-node-${{ matrix.node-version }}
        path: |
          results/versions/node_${{ matrix.node-version }}/
        retention-days: 30
    
    - name: Generate performance summary
      run: |
        echo "## Performance Summary for Node.js ${{ matrix.node-version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        VERSION_DIR="results/versions/node_${{ matrix.node-version }}"
        if [ -d "$VERSION_DIR" ]; then
          echo "### Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "**Iterations completed:** $(find $VERSION_DIR -name "iteration_*" -type d | wc -l)" >> $GITHUB_STEP_SUMMARY
          echo "**Total duration:** $(find $VERSION_DIR -name "iteration-summary.json" -exec jq -r '.summary.averageDuration // "N/A"' {} \;)" >> $GITHUB_STEP_SUMMARY
          
          # Show iteration summary if available
          if [ -f "$VERSION_DIR/iteration-summary.json" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Iteration Summary:**" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            jq '.summary' "$VERSION_DIR/iteration-summary.json" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "⚠️ No results directory found for this version" >> $GITHUB_STEP_SUMMARY
        fi

  compare-versions:
    runs-on: ubuntu-latest-4-cores
    needs: [benchmark, setup-versions]
    if: always()
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download all benchmark results
      uses: actions/download-artifact@v4
      with:
        path: ./downloaded-results
    
    - name: Setup Node.js (latest)
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Prepare results directory
      run: |
        mkdir -p results/versions
        
        # Copy all downloaded results to the results directory
        for artifact in downloaded-results/*/; do
          if [ -d "$artifact" ]; then
            echo "Processing artifact: $artifact"
            # Extract version from artifact name
            version_name=$(basename "$artifact" | sed 's/benchmark-results-node-//')
            target_dir="results/versions/node_$version_name"
            
            echo "Copying to: $target_dir"
            cp -r "$artifact"/* "$target_dir/" 2>/dev/null || true
            
            # Ensure proper structure
            if [ ! -d "$target_dir" ]; then
              mkdir -p "$target_dir"
            fi
          fi
        done
        
        echo "Final results structure:"
        find results/versions -type d | head -20
    
    - name: Generate version comparison report
      run: |
        echo "🔍 Generating comprehensive version comparison report..."
        npm run compare-versions
        
        echo "📊 Comparison report generated"
        ls -la docs/
    
    - name: Generate additional reports
      run: |
        echo "📝 Generating additional performance reports..."
        npm run generate-report
        
        echo "📈 All reports generated"
        ls -la docs/
    
    - name: Upload comparison results
      uses: actions/upload-artifact@v4
      with:
        name: version-comparison
        path: |
          results/
          docs/
        retention-days: 30

  performance-regression:
    runs-on: ubuntu-latest-4-cores
    needs: [benchmark, setup-versions]
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download benchmark results
      uses: actions/download-artifact@v4
      with:
        name: benchmark-results-node-20.11.0
        path: ./pr-results
    
    - name: Checkout main branch
      uses: actions/checkout@v4
      with:
        ref: main
        path: ./main-branch
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.11.0'
        cache: 'npm'
    
    - name: Run baseline benchmark (main branch)
      working-directory: ./main-branch
      run: |
        npm ci
        npm run benchmark
        mkdir -p ../baseline-results
        cp results/benchmark_*.json ../baseline-results/
    
    - name: Compare performance
      run: |
        echo "## Performance Regression Analysis" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        BASELINE=$(ls baseline-results/benchmark_*.json | head -1)
        CURRENT=$(ls pr-results/benchmark_*.json | head -1)
        
        if [ -f "$BASELINE" ] && [ -f "$CURRENT" ]; then
          echo "Comparing performance between main branch and PR..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Baseline (main branch)" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          jq '.benchmarks[] | {name: .name, overhead: .overhead.timePercent}' "$BASELINE" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Current (PR)" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          jq '.benchmarks[] | {name: .name, overhead: .overhead.timePercent}' "$CURRENT" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        else
          echo "⚠️ Could not find benchmark files for comparison" >> $GITHUB_STEP_SUMMARY
        fi
